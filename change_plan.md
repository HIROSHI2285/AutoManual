# AutoManual Studio — 変更計画まとめ

## 変更ファイル

| ファイル | 配置場所 |
|---------|---------|
| `page.tsx` | `app/page.tsx` |
| `route.ts` | `app/api/analyze-video/route.ts` |

---

## page.tsx の変更内容

### 動画圧縮処理の追加（新規関数 `compressVideoForAnalysis`）

Geminiへ送信する前にブラウザ上で動画を圧縮する。  
スクリーンショットは**元動画から取得**するため、マニュアルの画像品質は影響なし。

**圧縮パラメータ：**

| 項目 | 変更前 | 変更後 |
|------|--------|--------|
| 解像度 | 元動画そのまま | 854×480（SD） |
| フレームレート | 元動画そのまま | 10fps |
| ビットレート | 元動画そのまま | 500kbps |
| 形式 | 元動画そのまま | WebM |
| ファイルサイズ | 数十〜数百MB | 約1/5〜1/10 |

**フォールバック：** 圧縮失敗・非対応ブラウザでは自動的に元ファイルを使用。  
**実装：** `MediaRecorder API` + `canvas.captureStream()` でサーバー不要。

---

## route.ts の変更内容

### 1. Geminiモデルの変更

| 項目 | 変更前 | 変更後 |
|------|--------|--------|
| モデル | `gemini-2.0-flash` | `gemini-2.5-flash-preview-04-17` |
| 動画理解精度 | △ | ○ |
| 速度 | ◎ | ◎（ほぼ同等） |
| 無料枠 | 1500回/日 | 500回/日 |

### 2. ポーリング間隔の短縮

Gemini処理完了の確認間隔を短縮。

| 項目 | 変更前 | 変更後 |
|------|--------|--------|
| ポーリング間隔 | 2000ms | 500ms |
| 最大無駄待ち時間 | 2秒 | 0.5秒 |

### 3. プロンプトの全面改訂

**問題の根本原因：** 旧プロンプトが「重要な操作を抽出」という指示のため、Geminiが自己判断でステップを間引いていた。

**主な変更点：**

| 問題 | 変更前 | 変更後 |
|------|--------|--------|
| ステップが抜ける | 「重要な操作を特定してください」 | 「全ての操作を記録。スキップ禁止」 |
| ステップ数が少ない | 期待値の記載なし | 「1〜3分なら10〜25ステップ程度」と明示 |
| 説明文が的外れ | 曖昧な指示 | 「映像に映っているものだけを根拠にすること。推測・補完禁止」 |
| label が抽象的 | 指定なし | 「部品」ではなく「M6ボルト」のように具体名を要求 |
| PC操作専用 | PC操作の記述のみ | あらゆる動作パターンを列挙した汎用プロンプト |

**対応できる動画の種類（拡張）：**
- PC・スマホ・タブレットの画面操作
- 組み立て・製造・工具を使った作業
- 点検・確認・チェック作業
- 調理・料理手順
- その他あらゆる手順動画

---

## 改善効果まとめ

| 項目 | 改善前 | 改善後 |
|------|--------|--------|
| Geminiへの送信サイズ | 元動画そのまま | 約1/5〜1/10 |
| アップロード時間 | 大 | 大幅短縮 |
| Gemini処理待ち | 大 | 短縮 |
| ポーリング無駄待ち | 最大2秒 | 最大0.5秒 |
| ステップ抽出数（1〜3分） | 5〜8ステップ程度 | 10〜25ステップ |
| マニュアル画像の品質 | 高解像度 | 変わらず高解像度 |
| 対応動画の種類 | PC操作のみ | あらゆる手順動画 |
